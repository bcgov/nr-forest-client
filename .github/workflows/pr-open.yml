name: Pull Request Open

on:
  pull_request:
  workflow_dispatch:

concurrency:
  # PR open and close use the same group, allowing only one at a time
  group: ${{ github.event.number }}
  cancel-in-progress: true

jobs:
  vars:
    name: Variables
    runs-on: ubuntu-latest
    outputs:
      semver: ${{ steps.semver.outputs.tag }}
      url: ${{ steps.calculate.outputs.url }}
    steps:
      # steps.semver.outputs.tag => needs.vars.outputs.semver
      - uses: actions/checkout@v4
        with:
          ref: refs/heads/${{ github.event.repository.default_branch }}
      - name: Conventional Changelog Update
        uses: TriPSs/conventional-changelog-action@v5.2.1
        id: semver
        with:
          git-branch: refs/heads/${{ github.head_ref }}
          git-push: 'false'
          skip-commit: 'true'
          skip-on-empty: 'false'
          skip-version-file: 'true'

      # steps.calculate.outputs.url => needs.vars.outputs.url
      - name: Calculate the deployment number
        id: calculate
        run: |
          echo "url=${{ github.event.repository.name }}-$((${{ github.event.number }} % 50))-frontend.apps.silver.devops.gov.bc.ca" >> $GITHUB_OUTPUT

      - run: |
          echo "semver=${{ steps.semver.outputs.tag }}"
          echo "url=${{ steps.calculate.outputs.url }}"

  # builds:
  #   name: Builds
  #   runs-on: ubuntu-22.04
  #   needs: [vars]
  #   permissions:
  #     packages: write
  #   strategy:
  #     matrix:
  #       package: [backend, common, database, frontend, legacy, processor]
  #   steps:
  #     - uses: actions/checkout@v4

  #     - uses: bcgov-nr/action-builder-ghcr@v2.0.2
  #       name: Build (${{ matrix.package }})
  #       with:
  #         package: ${{ matrix.package }}
  #         tag: ${{ github.event.number }}
  #         tag_fallback: test
  #         triggers: ('${{ matrix.package }}/')
  #         build_args: |
  #           APP_VERSION=${{ needs.vars.outputs.semver }}-${{ github.event.number }}

  deploy:
    name: Deploy
    needs: [vars]
    secrets: inherit
    uses: ./.github/workflows/.deploy.yml
    with:
      cognito_redirect_uri: 'https://${{ github.event.repository.name }}-${{ needs.vars.outputs.semver }}-frontend.apps.silver.devops.gov.bc.ca/dashboard'
      environment: dev
      target: ${{ github.event.number }}
      url_zone: ${{ needs.vars.outputs.url_zone }}
