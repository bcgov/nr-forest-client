name: Pull Request Open

on:
  pull_request:
  workflow_dispatch:

concurrency:
  # PR open and close use the same group, allowing only one at a time
  group: ${{ github.event.number }}
  cancel-in-progress: true

jobs:
  vars:
    name: Variables
    runs-on: ubuntu-latest
    outputs:
      semver: ${{ steps.semver.outputs.tag }}
      url: ${{ steps.calculate.outputs.url }}
    steps:
      # steps.semver.outputs.tag => needs.vars.outputs.semver
      - uses: actions/checkout@v4
        with:
          ref: refs/heads/${{ github.event.repository.default_branch }}
      - name: Conventional Changelog Update
        uses: TriPSs/conventional-changelog-action@v5.2.1
        id: semver
        with:
          git-branch: refs/heads/${{ github.head_ref }}
          git-push: 'false'
          skip-commit: 'true'
          skip-on-empty: 'false'
          skip-version-file: 'true'

      # steps.calculate.outputs.url => needs.vars.outputs.url
      - name: Calculate the deployment number
        id: calculate
        run: |
          echo "url=${{ github.event.repository.name }}-$((${{ github.event.number }} % 50))-frontend.apps.silver.devops.gov.bc.ca" >> $GITHUB_OUTPUT

      - run: |
          echo "semver=${{ steps.semver.outputs.tag }}"
          echo "url=${{ steps.calculate.outputs.url }}"

  # builds:
  #   name: Builds
  #   runs-on: ubuntu-22.04
  #   needs: [vars]
  #   permissions:
  #     packages: write
  #   strategy:
  #     matrix:
  #       package: [backend, common, database, frontend, legacy, processor]
  #   steps:
  #     - uses: actions/checkout@v4

  #     - uses: bcgov-nr/action-builder-ghcr@v2.0.2
  #       name: Build (${{ matrix.package }})
  #       with:
  #         package: ${{ matrix.package }}
  #         tag: ${{ github.event.number }}
  #         tag_fallback: test
  #         triggers: ('${{ matrix.package }}/')
  #         build_args: |
  #           APP_VERSION=${{ needs.vars.outputs.semver }}-${{ github.event.number }}

  deploy:
    name: Deploy
    needs: [vars]
    secrets: inherit
    uses: ./.github/workflows/.deploy.yml
    with:
      environment: dev
      target: ${{ github.event.number }}
      url: ${{ needs.vars.outputs.url }}

  cypress-run:
    name: "User flow test"
    runs-on: ubuntu-22.04
    needs: [deploy, vars]
    environment: dev
    env:
      URL: ${{ needs.vars.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        name: Start node
        with:
          node-version: 18

      - name: Run Cypress End-to-End
        uses: cypress-io/github-action@v5
        with:
          working-directory: cypress
        env:
          CYPRESS_baseUrl: https://${{ env.URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Cypress Results
        uses: mikepenz/action-junit-report@v4
        continue-on-error: true
        if: always()
        with:
          report_paths: cypress/result.xml
          commit: ${{ github.event.pull_request.head.sha }}
          summary: Cypress Test Results
          detailed_summary: true
          job_name: User Journeys

      - uses: actions/upload-artifact@v4
        name: Upload Cypress Screenshots with error
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/cypress/screenshots
          retention-days: 7

      - uses: actions/upload-artifact@v4
        name: Upload Cypress Videos with error
        if: failure()
        with:
          name: cypress-videos
          path: cypress/cypress/videos
          retention-days: 7
